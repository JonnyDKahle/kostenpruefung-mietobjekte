{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>{{ heading }}</title>
    <link rel="stylesheet" href="{% static 'kostenpruefung_mietobjekte_app/style.css' %}">
</head>
<body>
<div class="flex-container">
    <nav class="sidebar">
        <a class="sidebar-link" href="{% url 'kostenpruefung_mietobjekte_app:objekt_index' %}">Objekt</a>
        <a class="sidebar-link" href="{% url 'kostenpruefung_mietobjekte_app:mieter_laufend' %}">Mieter</a>
        <ul style="list-style-type: disc; margin-left: 30px; margin-bottom: 20px;">
            <li><a href="{% url 'kostenpruefung_mietobjekte_app:mieter_laufend' %}">Laufend</a></li>
            <li><a href="{% url 'kostenpruefung_mietobjekte_app:mieter_zukuenftig' %}">Zukuenftig</a></li>
            <li><a href="{% url 'kostenpruefung_mietobjekte_app:mieter_archiv' %}">Archiv</a></li>
        </ul>
        <a class="sidebar-link" href="{% url 'kostenpruefung_mietobjekte_app:rechnungen' %}">Kosten</a>
        <a class="sidebar-link" href="{% url 'kostenpruefung_mietobjekte_app:konto' %}">Konto</a>
        <a class="sidebar-link" href="{% url 'kostenpruefung_mietobjekte_app:auswertung' %}">Auswertung</a>
    </nav>
    <div class="main-content">
        <h2>{{ heading }}</h2>
        
        <div class="button-group">
            <form action="{% url 'kostenpruefung_mietobjekte_app:mieter_create_step1' %}" method="get">
                <button class="action-btn" type="submit">Neuen Mieter anlegen</button>
            </form>
            
            <!-- New dropdown for Mieter without Mietverhaeltnis -->
            {% if mieter_without_mietverhaeltnis %}
            <div class="dropdown-container">
                <label for="mieter-select">Mietverhältnis für vorhandenen Mieter anlegen:</label>
                <select id="mieter-select" name="mieter_id">
                    <option value="">-- Mieter auswählen --</option>
                    {% for m in mieter_without_mietverhaeltnis %}
                        <option value="{{ m.id }}">{{ m.vorname }} {{ m.nachname }}</option>
                    {% endfor %}
                </select>
                <button id="create-mietverhaeltnis-btn" class="action-btn" disabled>Mietverhältnis anlegen</button>
            </div>
            {% endif %}
        </div>
        
        <!-- Header row explaining the hierarchical display -->
        <div class="info-box" style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-left: 4px solid #4e79a7;">
            <p>Diese Ansicht zeigt Mieter mit ihren zugehörigen Mietverhältnissen.</p>
        </div>
        
        <table class="object-table">
            <tr>
                <th colspan="5">Mieter-Information</th>
                <th colspan="11">Mietverhältnis-Information</th>
                <th>Aktionen</th>
            </tr>
            <tr>
                <th>Vorname</th>
                <th>Nachname</th>
                <th>Telefon</th>
                <th>E-Mail</th>
                <th>Geburtsdatum</th>
                <th>Straße/Hausnr.</th>
                <th>PLZ</th>
                <th>Ort</th>
                <th>Land</th>
                <th>Vertragsbeginn</th>
                <th>Vertragsende</th>
                <th>Kaltmiete</th>
                <th>Nebenkosten</th>
                <th>Kaution</th>
                <th>Mietobjekte</th>
                <th>Mieteinheiten</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
            
            {% for m in mieter %}
            <!-- Tenant row -->
            <tr class="mieter-row">
                <td>{{ m.vorname }}</td>
                <td>{{ m.nachname }}</td>
                <td>{{ m.telefon }}</td>
                <td>{{ m.e_mail }}</td>
                <td>{{ m.geburtsdatum }}</td>
                <td colspan="11" style="text-align: center;">
                    <form action="{% url 'kostenpruefung_mietobjekte_app:mietverhaeltnis_create' m.id %}" method="get">
                        <button class="action-btn" type="submit">Neues Mietverhältnis anlegen</button>
                    </form>
                </td>
                <td class="objekt-actions">
                    <form action="{% url 'kostenpruefung_mietobjekte_app:mieter_update' m.id %}" method="get" style="display:inline;">
                        <button class="action-btn" type="submit">Bearbeiten</button>
                    </form>
                    <form action="{% url 'kostenpruefung_mietobjekte_app:mieter_delete' m.id %}" method="get" style="display:inline;">
                        <button class="action-btn" type="submit">Löschen</button>
                    </form>
                </td>
            </tr>
            
            <!-- Lease contracts for this tenant -->
            {% for mv in m.mietverhaeltnisse.all %}
            <tr class="mietverhaeltnis-row">
                <td colspan="5" style="text-align: right;">
                    <span class="lease-label">Mietverhältnis {{ forloop.counter }}:</span>
                </td>
                <td>{{ mv.strasse_hausnummer }}</td>
                <td>{{ mv.plz }}</td>
                <td>{{ mv.ort }}</td>
                <td>{{ mv.land }}</td>
                <td>{{ mv.vertragsbeginn }}</td>
                <td>{{ mv.vertragsende }}</td>
                <td>{{ mv.kaltmiete }}</td>
                <td>{{ mv.nebenkosten }}</td>
                <td>{{ mv.kaution }}</td>
                <td>
                    {% for obj in mv.mietobjekte.all %}
                        {{ obj.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        -
                    {% endfor %}
                </td>
                <td>
                    {% for einheit in mv.mieteinheiten.all %}
                        {{ einheit.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        -
                    {% endfor %}
                </td>
                <td>{{ mv.mietstatus }}</td>
                <td class="objekt-actions">
                    <!-- Add actions for Mietverhaeltnis -->
                </td>
            </tr>
            {% empty %}
            <tr class="mietverhaeltnis-empty-row">
                <td colspan="18" style="text-align: center; font-style: italic;">Keine Mietverhältnisse vorhanden</td>
            </tr>
            {% endfor %}
            
            {% empty %}
            <tr>
                <td colspan="18">Keine Mieter vorhanden.</td>
            </tr>
            {% endfor %}
        </table>
        
        <script>
            // Enable/disable the button based on selection
            document.addEventListener('DOMContentLoaded', function() {
                const select = document.getElementById('mieter-select');
                const button = document.getElementById('create-mietverhaeltnis-btn');
                
                if (select && button) {
                    select.addEventListener('change', function() {
                        if (this.value) {
                            button.disabled = false;
                            // Update the button's URL when a mieter is selected
                            button.onclick = function() {
                                window.location.href = "{% url 'kostenpruefung_mietobjekte_app:mietverhaeltnis_create' 0 %}".replace('0', select.value);
                            }
                        } else {
                            button.disabled = true;
                        }
                    });
                }
            });
        </script>
    </div>
</div>
</body>
</html>