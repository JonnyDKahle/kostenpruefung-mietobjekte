{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Auswertung</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="{% static 'kostenpruefung_mietobjekte_app/style.css' %}">
</head>
<body>
<div class="flex-container">
    <nav class="sidebar">
        <a class="sidebar-link" href="{% url 'objekt_index' %}">Objekt</a>
        <a class="sidebar-link" href="{% url 'mieter_laufend' %}">Mieter</a>
        <a class="sidebar-link" href="{% url 'rechnungen' %}">Kosten</a>
        <a class="sidebar-link" href="{% url 'konto' %}">Konto</a>
        <a class="sidebar-link" href="{% url 'auswertung' %}">Auswertung</a>
    </nav>
    <div class="main-content">
        <h2>Auswertung</h2>
        
        <form method="get" class="filters-form">
            <div class="filter-section">
                <div class="filter-row">
                    <label for="mietobjekt">Mietobjekt:</label>
                    <select name="mietobjekt" id="mietobjekt">
                        <option value="">-- Bitte wählen --</option>
                        {% for obj in mietobjekte %}
                            <option value="{{ obj.id }}" {% if selected_objekt and obj.id == selected_objekt.id %}selected{% endif %}>{{ obj.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-row">
                    <label for="time_filter">Zeitraum:</label>
                    <select name="time_filter" id="time_filter">
                        <option value="current_year" {% if time_filter == 'current_year' or not time_filter %}selected{% endif %}>Aktuelles Jahr</option>
                        <option value="last_year" {% if time_filter == 'last_year' %}selected{% endif %}>Letztes Jahr</option>
                        <option value="total" {% if time_filter == 'total' %}selected{% endif %}>Gesamt</option>
                        <option value="month_year" {% if time_filter == 'month_year' %}selected{% endif %}>Monat/Jahr</option>
                        <option value="custom_range" {% if time_filter == 'custom_range' %}selected{% endif %}>Zeitraum</option>
                    </select>
                </div>
                
                <div class="filter-row month-year-filter">
                    <label for="month">Monat:</label>
                    <select name="month" id="month">
                        <option value="1" {% if month == '1' %}selected{% endif %}>Januar</option>
                        <option value="2" {% if month == '2' %}selected{% endif %}>Februar</option>
                        <option value="3" {% if month == '3' %}selected{% endif %}>März</option>
                        <option value="4" {% if month == '4' %}selected{% endif %}>April</option>
                        <option value="5" {% if month == '5' %}selected{% endif %}>Mai</option>
                        <option value="6" {% if month == '6' %}selected{% endif %}>Juni</option>
                        <option value="7" {% if month == '7' %}selected{% endif %}>Juli</option>
                        <option value="8" {% if month == '8' %}selected{% endif %}>August</option>
                        <option value="9" {% if month == '9' %}selected{% endif %}>September</option>
                        <option value="10" {% if month == '10' %}selected{% endif %}>Oktober</option>
                        <option value="11" {% if month == '11' %}selected{% endif %}>November</option>
                        <option value="12" {% if month == '12' %}selected{% endif %}>Dezember</option>
                    </select>
                    
                    <label for="year">Jahr:</label>
                    <select name="year" id="year">
                        {% for year_option in available_years %}
                            <option value="{{ year_option }}" {% if year == year_option %}selected{% endif %}>{{ year_option }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-row date-range-filter">
                    <label for="start_date">Von:</label>
                    <input type="date" name="start_date" id="start_date" value="{{ start_date|date:'Y-m-d' }}">
                    
                    <label for="end_date">Bis:</label>
                    <input type="date" name="end_date" id="end_date" value="{{ end_date|date:'Y-m-d' }}">
                </div>
                
                <div class="filter-row">
                    <button type="submit" class="action-btn">Filter anwenden</button>
                </div>
            </div>
        </form>
        
        {% if filter_display %}
        <div class="filter-info">
            <h3>Zeitraum: {{ filter_display }}</h3>
        </div>
        {% endif %}
        
        {% if selected_objekt %}
        <div class="auswertung-flex">
            <div class="auswertung-left">
                <h3>{{ selected_objekt.name }}</h3>
                <p><strong>Einnahmen:</strong> {{ einnahmen|floatformat:2 }} €</p>
                <p><strong>Ausgaben:</strong> {{ ausgaben|floatformat:2 }} €</p>
                <p><strong>Ergebnis:</strong> {{ ergebnis|floatformat:2 }} €</p>
            </div>
            <div class="auswertung-right">
                <p><strong>Einnahmen Pie Chart:</strong></p>
                <div id="einnahmenGoogleChart"></div>

                <p><strong>Ausgaben Pie Chart:</strong></p>
                <div id="ausgabenGoogleChart"></div>
            </div>
        </div>
        
        {{ einnahmen_labels|json_script:"einnahmenLabelsData" }}
        {{ einnahmen_values|json_script:"einnahmenValuesData" }}
        {{ chart_labels|json_script:"chartLabelsData" }}
        {{ chart_values|json_script:"chartValuesData" }}
        
        <script>
            // Google Chart for Einnahmen
            try {
                const einnahmenLabels = JSON.parse(document.getElementById('einnahmenLabelsData').textContent || '[]');
                const einnahmenValues = JSON.parse(document.getElementById('einnahmenValuesData').textContent || '[]');

                if (einnahmenLabels.length > 0 && einnahmenValues.length > 0) {
                    google.charts.load('current', { packages: ['corechart'] });
                    google.charts.setOnLoadCallback(drawEinnahmenChart);

                    function drawEinnahmenChart() {
                        const chartDiv = document.getElementById('einnahmenGoogleChart');
                        const data = new google.visualization.DataTable();
                        data.addColumn('string', 'Buchungsart');
                        data.addColumn('number', 'Betrag');

                        for (let i = 0; i < einnahmenLabels.length; i++) {
                            data.addRow([einnahmenLabels[i], parseFloat(einnahmenValues[i])]);
                        }

                        const options = {
                            title: 'Einnahmen nach Buchungsart',
                            pieHole: 0.4,
                            width: 400,
                            height: 400,
                            colors: ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7'],
                            legend: { position: 'bottom' }
                        };

                        const chart = new google.visualization.PieChart(chartDiv);
                        chart.draw(data, options);
                    }
                }
            } catch (error) {
                console.error("Error in Einnahmen chart initialization:", error);
            }

            // Google Chart for Ausgaben
            try {
                const chartLabels = JSON.parse(document.getElementById('chartLabelsData').textContent || '[]');
                const chartValues = JSON.parse(document.getElementById('chartValuesData').textContent || '[]');

                if (chartLabels.length > 0 && chartValues.length > 0) {
                    google.charts.load('current', { packages: ['corechart'] });
                    google.charts.setOnLoadCallback(drawAusgabenChart);

                    function drawAusgabenChart() {
                        const chartDiv = document.getElementById('ausgabenGoogleChart');
                        const data = new google.visualization.DataTable();
                        data.addColumn('string', 'Buchungsart');
                        data.addColumn('number', 'Betrag');

                        for (let i = 0; i < chartLabels.length; i++) {
                            data.addRow([chartLabels[i], parseFloat(chartValues[i])]);
                        }

                        const options = {
                            title: 'Ausgaben nach Buchungsart',
                            pieHole: 0.4,
                            width: 400,
                            height: 400,
                            colors: ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7'],
                            legend: { position: 'bottom' }
                        };

                        const chart = new google.visualization.PieChart(chartDiv);
                        chart.draw(data, options);
                    }
                }
            } catch (error) {
                console.error("Error in Ausgaben chart initialization:", error);
            }
        </script>
        {% endif %}
    </div>
</div>
</body>
</html>